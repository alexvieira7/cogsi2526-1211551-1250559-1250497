- hosts: green
  become: yes

  vars:
    tag: "{{ tag }}"
    stable_jar_source: "../artifacts/app-{{ tag }}.jar"
    app_jar_dest: "/opt/app/app.jar"

  tasks:
    - name: Parar serviço atual
      ansible.builtin.service:
        name: app
        state: stopped
    ignore_errors: true

    - name: Copiar artefacto estável
      copy:
        src: "{{ stable_jar_source }}"
        dest: "{{ app_jar_dest }}"
        mode: '0755'

    - name: Reiniciar serviço com versão estável
      systemd:
        name: app
        state: restarted
        enabled: yes

    - name: Health check após rollback
      uri:
        url: "http://localhost:8080/employees"
        status_code: 200
